# 基本的な使い方

基本的な使い方の入門として、 `pendulum` という日付ライブラリをインストールします。
Poetryをまだインストールしていない場合は、 [Introduction](/docs/) の章を参照してください。

## プロジェクトのセットアップ

最初に、新しいプロジェクトを作成し、 `poetry-demo` と名付けましょう:

```bash
poetry new poetry-demo
```


このコマンドは、次の内容を持つ `poetry-demo` ディレクトリを作成します:

```text
poetry-demo
├── pyproject.toml
├── README.rst
├── poetry_demo
│   └── __init__.py
└── tests
    ├── __init__.py
    └── test_poetry_demo.py
```


`pyproject.toml` ファイルがここでは最も重要なものです。
このファイルが、プロジェクトの依存関係を統括します。
今のところの中身は、このようになっています:

```toml
[tool.poetry]
name = "poetry-demo"
version = "0.1.0"
description = ""
authors = ["Sébastien Eustace <sebastien@eustace.io>"]

[tool.poetry.dependencies]
python = "*"

[tool.poetry.dev-dependencies]
pytest = "^3.4"
```


### 依存関係の指定

プロジェクトに依存関係を追加したい場合は、 `tool.poetry.dependencies` セクションに指定できます。

```toml
[tool.poetry.dependencies]
pendulum = "^1.4"
```


見て分かるように、このセクションには **パッケージ名** と **バージョン制約** の対応付けを書きます。

Poetryはこの情報を使い、 `tool.poetry.repositories` セクションに登録されたパッケージ "レポジトリ"
もしくはデフォルトの [PyPI](https://pypi.org) から、正しいファイル群を検索します。

`pyproject.toml` ファイルを手で編集する変わりに、 `add` コマンドも使えます。

```bash
$ poetry add pendulum
```


このコマンドは自動的に適切なバージョン制約を見付け、パッケージとその依存関係を **インストールします** 。


### バージョン制約

今の例では、 `^1.4` というバージョン制約の付いた  `pendulum` パッケージを要求しています。
この制約は、1.4.0以上かつ2.0.0未満のバージョンという意味です (`>=1.4.0 <2.0.0`)。

バージョンやバージョンどうしの関係、バージョン制約について、より深いことについては [versions](/docs/versions/)
を読んでください。


!!!注意

    **Poetryはどうやって正しいファイルをダウンロードするのか?**

    `pyproject.toml` に依存関係を指定しているとき、Poetryはまず最初に要求されたパッケージ名を取り出し、
    `repositories` キーに登録されたレポジトリを検索します。
    追加のレポジトリを登録していないか、指定したレポジトリから要求された名前の
    パッケージが見付からない場合は、PyPIに戻って検索します。

    Poetryが正しいパッケージを複数見付けたときは、指定されたバージョン制約に
    最も適合するものを見付けようとします。


## 依存関係のインストール

プロジェクトに定義された依存関係をインストールするには、 `install` コマンドを実行するだけです。

```bash
poetry install
```


このコマンドを実行すると、2つのうちどちらかが起こります:

### `poetry.lock` 無しのインストール

以前にこのコマンドを実行したことが無く、 `poetry.lock` ファイルも存在しない場合は、Poetryは `pyproject.toml`
に並べられた全ての依存関係を解決し、それらのファイルの最新バージョンをダウンロードするだけです。

Poetryがインストールを完了すると、ダウンロードしたパッケージとその正確なバージョンを `poetry.lock`
へ書き込み、その特定のバージョンでプロジェクトを固定します。
プロジェクトレポジトリに `poetry.lock`
ファイルをコミットし、このプロジェクトに携わる全ての人にとって、同じバージョンの依存関係を強制されるべきです (下でさらに解説します)。


### `poetry.lock` 有りのインストール

こちらの場合は先程とは別の第2のシナリオになります。
`poetry install` を実行するときに、 `pyproject.toml` に加えて既に `poetry.lock`
ファイルがある場合は、以前に `install` コマンドを実行していたか、誰か他の人がそのプロジェクトで `install` コマンドを実行し
`poetry.lock` ファイルをプロジェクトにコミット (これは良い行いです) していたことになります。

どちらにせよ、 `poetry.lock` ファイルがあるときに `install` コマンドを実行すると `pyproject.toml`
に並べた全ての依存関係を解決しインストールしますが、Poetryは `poetry.lock`
に並べられた正確なバージョンを使い、プロジェクトに携わる全ての人にとってパッケージバージョンが一貫性を持つことを保証します。
その結果として、 `pyproject.toml`
ファイルで要求された全ての依存関係が手に入りますが、必ずしも全ての依存関係が利用可能な最新バージョンではないかもしれません (`poetry.lock`
ファイルに並べられている依存関係のうちいくつかは、そのファイルが作成された後により新しいバージョンがリリースされているかもしれません)。
これは設計によるもので、プロジェクトが予期せぬ依存関係の変更で壊れないことを保証するものです。

### `poetry.lock` ファイルをバージョン管理にコミット

このファイルをVC (Version Control)
にコミットするのが重要なのは、あなたが使っているバージョンと厳密に同じバージョンの依存関係を、プロジェクトをセットアップする人が使うようにするためです。
あなたのCIサーバー、本番機、チームの他の開発者、全てのもの、全ての人が同じ依存関係の上で実行することで、配置物の一部だけに影響するバグが起きる恐れを軽減します。
6ヶ月間1人で開発をしたとしても、プロジェクトを再インストールするときには、インストールされた依存関係は今でも正常に動作すると確信を持てます。たとえ依存関係に多くの新バージョンがリリースされていたとしてもです。
(下にあるupdateコマンドの使い方についての注意書きを参照してください。)

!!!注意

    ライブラリについては、ロックファイルをコミットするのは必須ではありません。


## 依存関係の最新バージョンへの更新

上で言及したように、 `poetry.lock` ファイルは依存関係の最新バージョンを自動的に取得してしまうのを防止します。
最新バージョンへ更新するには、 `update` コマンドを使ってください。
このコマンドは適合する最新バージョンを (`pyproject.toml` ファイルに従って)
取ってきて、ロックファイルを新しいバージョンで更新します。
(この動作は、 `poetry.lock` ファイルを削除してから、改めて `install` を実行するのと同等です。)

!!!注意

    Poetryは、installコマンドを実行するときに `poetry.lock` と `pyproject.toml` が同期されていない場合、
    **警告** を表示します。


## Poetryと仮想環境

`install` コマンドを実行するとき (あるいは `add` コマンドや `remove` コマンドのような他の "インストール"
コマンド)、Poetryは現在は仮想環境の中なのかどうかを調べ、もしそうでなければ既存の仮想環境または新品の仮想環境を使い、グローバルにインストールされたPythonから常に隔離します。

!!!注意

    現在のプロジェクト用の仮想環境を作成するために、
    Poetryは現在有効になっているバージョンのPythonを使います。

    Pythonのバージョンを簡単に切り替えるには、
    [pyenv](https://github.com/pyenv/pyenv) やそれに似たツールを使うのが推奨されます。

    例えば、プロジェクトがPython 2.7のみの場合、
    標準的な作業の流れは次のようになります:

    ```bash
    pyenv install 2.7.15
    pyenv local 2.7.15  # Activate Python 2.7 for the current project
    poetry install
    ```
